version: '3.9'

# ClawOps local development environment
# Usage: docker compose up -d
# Requires: .env file with provider API keys and gateway credentials

services:
  # ─── clawnode: VPS instance agent ──────────────────────────────────────────
  clawnode:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: clawnode-dev
    restart: unless-stopped
    env_file:
      - .env
    environment:
      CLAWNODE_INSTANCE_ID: ${CLAWNODE_INSTANCE_ID:-dev-instance-001}
      CLAWNODE_ACCOUNT_ID: ${CLAWNODE_ACCOUNT_ID:-dev-account}
      CLAWNODE_GATEWAY_URL: ${CLAWNODE_GATEWAY_URL:-ws://host.docker.internal:8443}
      CLAWNODE_AUTH_TOKEN: ${CLAWNODE_AUTH_TOKEN:-dev-auth-token}
      CLAWNODE_PROVIDER: ${CLAWNODE_PROVIDER:-hetzner}
      CLAWNODE_REGION: ${CLAWNODE_REGION:-eu-hetzner-nbg1}
      CLAWNODE_TIER: ${CLAWNODE_TIER:-standard}
      CLAWNODE_ROLE: ${CLAWNODE_ROLE:-primary}
      CLAWNODE_STATE_DIR: /var/lib/clawnode/state
      # Provider API keys (for provisioning operations)
      HETZNER_API_TOKEN: ${HETZNER_API_TOKEN:-}
      VULTR_API_KEY: ${VULTR_API_KEY:-}
      CONTABO_API_KEY: ${CONTABO_API_KEY:-}
      HOSTINGER_API_KEY: ${HOSTINGER_API_KEY:-}
      DO_API_TOKEN: ${DO_API_TOKEN:-}
      # Logging
      RUST_LOG: ${RUST_LOG:-clawnode=debug,claw_health=debug,claw_metrics=info,claw_provision=info}
    volumes:
      - clawnode-state:/var/lib/clawnode/state
      - clawnode-logs:/var/log/clawnode
    networks:
      - clawops-net
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8090/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    depends_on:
      redis:
        condition: service_healthy

  # ─── Redis: state cache and command queue ────────────────────────────────────
  # Used for: heartbeat deduplication, metrics ring buffer, command queuing
  redis:
    image: redis:7-alpine
    container_name: clawops-redis-dev
    restart: unless-stopped
    command: >
      redis-server
      --save 60 1
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - clawops-net
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

volumes:
  clawnode-state:
    driver: local
  clawnode-logs:
    driver: local
  redis-data:
    driver: local

networks:
  clawops-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
